<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Cek Barang (Indo - Jepang)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #17a2b8;
            --primary-hover: #138496;
            --success-color: #28a745;
            --error-color: #dc3545;
            --light-gray: #f9f9f9;
            --dark-text: #333;
        }
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: var(--light-gray); 
            color: var(--dark-text); 
            margin: 0; 
            padding: 15px; 
            -webkit-tap-highlight-color: transparent; /* Mencegah flash biru saat disentuh di mobile */
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background-color: #fff; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        h1 { 
            font-family: 'Poppins', sans-serif; 
            font-weight: 700; 
            text-align: center; 
            font-size: 1.5em; /* Ukuran font responsif */
        }
        .input-group { margin-bottom: 20px; }
        .flex-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .flex-group .input-group { flex: 1 1 150px; min-width: 120px; } /* Responsif untuk layar kecil */
        label { display: block; font-weight: 500; margin-bottom: 8px; }
        input[type="text"], input[type="tel"], input[type="number"], textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-family: 'Montserrat', sans-serif; 
            font-size: 16px; 
            box-sizing: border-box; 
        }
        textarea { resize: vertical; min-height: 100px; }
        .submit-btn { 
            width: 100%; 
            padding: 15px; 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 5px; 
            font-family: 'Poppins', sans-serif; 
            font-size: 18px; 
            cursor: pointer; 
            transition: background-color 0.3s ease; 
        }
        .submit-btn:hover:not(:disabled) { background-color: var(--primary-hover); }
        .submit-btn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .whatsapp-btn {
            display: none; /* Sembunyi secara default */
            width: 100%;
            padding: 12px;
            background-color: var(--success-color);
            color: white;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            margin-top: 10px;
        }
        #progressBarContainer {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
        #progressBar {
            width: 0%;
            height: 25px;
            background-color: var(--success-color);
            border-radius: 5px;
            text-align: center;
            line-height: 25px;
            color: white;
            font-size: 14px;
            transition: width 0.3s ease;
        }
        .popup {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-family: 'Poppins', sans-serif;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease, top 0.4s ease;
        }
        .popup.show {
            opacity: 1;
            visibility: visible;
            top: 30px;
        }
        .popup.success { background-color: var(--success-color); }
        .popup.error { background-color: var(--error-color); }
    </style>
</head>
<body>
    <div class="container">
        <h1>Form Cek Barang (Indo - Jepang)</h1>
        
        <form id="cekForm">
            <div class="input-group">
                <label for="nama">Nama</label>
                <input type="text" id="nama" name="nama" required>
            </div>
            <div class="input-group">
                <label for="whatsappNumber">Nomor WhatsApp</label>
                <input type="tel" id="whatsappNumber" name="whatsappNumber" placeholder="contoh: 08123456789">
            </div>
            <div class="input-group">
                <label for="listBarang">List Barang</label>
                <textarea id="listBarang" name="listBarang" required></textarea>
            </div>
            <div class="flex-group">
                <div class="input-group">
                    <label for="beratTotal">Berat Total (Bagasi)</label>
                    <input type="number" step="any" id="beratTotal" name="beratTotal" placeholder="angka saja, contoh: 5">
                </div>
                <div class="input-group">
                    <label for="beratKabin">Berat Kabin</label>
                    <input type="number" step="any" id="beratKabin" name="beratKabin" placeholder="angka saja, contoh: 2">
                </div>
            </div>
            <div class="flex-group">
                <div class="input-group">
                    <label for="beratKhusus">Berat Khusus</label>
                    <input type="number" step="any" id="beratKhusus" name="beratKhusus" placeholder="angka saja, contoh: 2">
                </div>
                <div class="input-group">
                    <label for="jumlahPack">Jumlah Pack</label>
                    <input type="number" id="jumlahPack" name="jumlahPack" placeholder="angka saja, contoh: 2">
                </div>
            </div>
            <div class="input-group">
                <label>Upload Foto Barang (Maks. 5)</label>
                <input type="file" name="fileUpload" accept="image/*" multiple style="margin-top: 8px;">
            </div>

            <div class="input-group">
                <label>Status Kelengkapan Barang</label>
                <div style="display: flex; gap: 20px; margin-top: 5px;">
                    <label><input type="radio" name="kelengkapanStatus" value="Lengkap" required> Lengkap</label>
                    <label><input type="radio" name="kelengkapanStatus" value="Belum Lengkap" required> Belum Lengkap</label>
                </div>
            </div>
            
            <div id="progressBarContainer">
                <div id="progressBar">0%</div>
            </div>

            <button type="submit" id="submitButton" class="submit-btn">Submit</button>
            <a href="#" id="whatsappButton" class="whatsapp-btn" target="_blank">Kirim ke WhatsApp</a>
        </form>
    </div>
    
    <div id="popup-notification" class="popup"></div>

    <script>
        // =========================================================================
        // PENTING: GANTI URL DI BAWAH DENGAN URL WEB APP ANDA DARI GOOGLE APPS SCRIPT
        // =========================================================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwa2rGtI78JoZJLHzUdm448JIyobRnjpO2roBQ9CvYQSL_UOX9n_N8-JQvLWmAlV9Ee/exec";

        const form = document.getElementById('cekForm');
        const submitButton = document.getElementById('submitButton');
        const whatsappButton = document.getElementById('whatsappButton');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const fileInput = document.querySelector('input[name="fileUpload"]');

        // Fungsi untuk menampilkan popup notifikasi
        function showPopup(message, isSuccess) {
            const popup = document.getElementById('popup-notification');
            popup.textContent = message;
            popup.className = 'popup show ' + (isSuccess ? 'success' : 'error');
            setTimeout(() => {
                popup.className = 'popup';
            }, 4000); // Popup akan hilang setelah 4 detik
        }

        function compressImage(file, quality = 0.6, maxSize = 1200) {
            return new Promise((resolve, reject) => {
                if (!file) return resolve(null);
                
                // Jika ukuran file sudah cukup kecil, tidak perlu kompresi
                if (file.size < 300 * 1024) { 
                    const reader = new FileReader();
                    reader.onload = e => resolve({ name: file.name, type: file.type, data: e.target.result });
                    reader.onerror = err => reject(err);
                    reader.readAsDataURL(file);
                    return;
                }

                const reader = new FileReader();
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let { width, height } = img;

                        if (width > height) {
                            if (width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(blob => {
                            const reader = new FileReader();
                            reader.onload = e => resolve({ name: file.name, type: blob.type, data: e.target.result });
                            reader.onerror = err => reject(err);
                            reader.readAsDataURL(blob);
                        }, 'image/jpeg', quality);
                    };
                };
                reader.onerror = err => reject(err);
                reader.readAsDataURL(file);
            });
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (SCRIPT_URL === "URL_WEB_APP_ANDA_DISINI") {
                showPopup("Harap masukkan URL Web App di dalam kode.", false);
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Mengirim...';
            progressBarContainer.style.display = 'block';

            let progress = 0;
            const interval = setInterval(() => {
                if (progress < 90) {
                    progress += 2;
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                }
            }, 100);

            try {
                const files = Array.from(fileInput.files).slice(0, 5);
                const filePromises = files.map(file => compressImage(file));
                const fileDataArray = await Promise.all(filePromises);

                const formData = {
                    nama: form.nama.value,
                    whatsappNumber: form.whatsappNumber.value,
                    listBarang: form.listBarang.value,
                    beratTotal: form.beratTotal.value,
                    beratKabin: form.beratKabin.value,
                    beratKhusus: form.beratKhusus.value,
                    jumlahPack: form.jumlahPack.value,
                    kelengkapanStatus: document.querySelector('input[name="kelengkapanStatus"]:checked').value,
                    file1: fileDataArray[0] || null,
                    file2: fileDataArray[1] || null,
                    file3: fileDataArray[2] || null,
                    file4: fileDataArray[3] || null,
                    file5: fileDataArray[4] || null
                };

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    redirect: 'follow',
                    body: JSON.stringify(formData)
                });
                
                clearInterval(interval);
                const result = await response.json();
                
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';

                if (result.status === 'success') {
                    showPopup('Input data berhasil!', true);
                    form.style.display = 'none'; // Sembunyikan form
                    whatsappButton.style.display = 'block';
                    whatsappButton.href = result.whatsappLink;
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                clearInterval(interval);
                showPopup('Input gagal: ' + error.message, false);
                resetFormState();
            }
        });

        function resetFormState() {
            progressBarContainer.style.display = 'none';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            submitButton.disabled = false;
            submitButton.textContent = 'Submit';
        }
    </script>
</body>
</html>
