<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cek Barang Indo Jepang</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #17a2b8;
            --success-color: #28a745;
            --error-color: #dc3545;
            --light-gray: #f9f9f9;
            --dark-gray: #333;
            --border-color: #ddd;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            margin: 0;
            padding: 1rem;
            padding-top: 70px;
            -webkit-text-size-adjust: 100%;
        }
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 10px 0;
            z-index: 1000;
        }
        .header-content {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .header-btn {
            padding: 8px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            color: white;
            transition: background-color 0.3s ease;
        }
        .blue-btn { background-color: #007bff; }
        .blue-btn:hover { background-color: #0056b3; }
        .green-btn { background-color: #28a745; }
        .green-btn:hover { background-color: #1e7e34; }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            text-align: center;
            font-size: 1.5rem;
            color: var(--dark-gray);
        }
        .input-group { margin-bottom: 1.25rem; }
        label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
        input[type="text"], input[type="tel"], textarea, input[type="file"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            box-sizing: border-box;
        }
        textarea { resize: vertical; min-height: 100px; }
        input[type="file"] { padding: 0.5rem; }
        .submit-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 5px;
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            display: block;
            box-sizing: border-box;
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s ease;
        }
        .submit-btn:hover:not(:disabled) { background-color: #138496; }
        .submit-btn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        #preview-container img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        #progressBarContainer {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin-top: 1.25rem;
            display: none;
        }
        #progressBar {
            width: 0%;
            height: 25px;
            background-color: var(--success-color);
            border-radius: 5px;
            text-align: center;
            line-height: 25px;
            color: white;
            font-size: 14px;
            transition: width 0.3s ease;
        }
        #status { text-align: center; margin-top: 15px; font-weight: 500; }
    </style>
</head>
<body>

<header class="fixed-header">
    <div class="header-content">
        <a href="#" class="header-btn blue-btn">Home</a>
        <a href="#" class="header-btn green-btn">Spreadsheet</a>
    </div>
</header>
    
<div class="container">
    <h1>Form Cek Barang Indo-Jepang</h1>
    <form id="submissionForm">
        <div class="input-group">
            <label for="nama">Nama</label>
            <input type="text" id="nama" name="nama">
        </div>
        <div class="input-group">
            <label for="whatsapp">Nomor WhatsApp</label>
            <input type="tel" id="whatsapp" name="whatsapp" placeholder="Contoh: 08123456789">
        </div>
        <div class="input-group">
            <label for="list-Barang">List Barang</label>
            <textarea id="list-Barang" name="listBarang"></textarea>
        </div>
        <div class="input-group">
            <label for="berat-total">Berat Total (kg)</label>
            <input type="tel" id="berat-total" name="beratTotal">
        </div>
        <div class="input-group">
            <label for="total-packing">Jumlah Packingan</label>
            <input type="tel" id="total-packing" name="jumlahPack" placeholder="angka saja, contoh: 5">
        </div>
        <div class="input-group">
            <label for="foto">Foto Barang (maks. 10 foto)</label>
            <input type="file" id="foto" name="foto" multiple accept="image/*">
            <div id="preview-container"></div>
        </div>
        <div class="input-group">
            <label>Status Kelengkapan Barang</label>
            <label style="display: inline-flex; align-items: center; margin-right: 15px; font-weight: normal;">
                <input type="radio" name="kelengkapanStatus" value="Lengkap" style="width: auto; margin-right: 8px;"> Lengkap
            </label>
            <label style="display: inline-flex; align-items: center; font-weight: normal;">
                <input type="radio" name="kelengkapanStatus" value="Belum Lengkap" style="width: auto; margin-right: 8px;"> Belum Lengkap
            </label>
        </div>
        
        <button type="submit" class="submit-btn" id="submit-btn">Kirim Data & Notifikasi</button>
        
        <div id="progressBarContainer">
            <div id="progressBar">0%</div>
        </div>
        <div id="status"></div>
    </form>
</div>

<script>
    // ================================================================
    // KONFIGURASI
    // ================================================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwa2rGtI78JoZJLHzUdm448JIyobRnjpO2roBQ9CvYQSL_UOX9n_N8-JQvLWmAlV9Ee/exec'; // Ganti dengan URL Google Apps Script Anda

    // ⬇️⬇️ PASTE KUNCI KONFIGURASI FIREBASE ANDA DI SINI ⬇️⬇️
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyDqLE8jpK9zR8cYU4uox-ZRfGRkURsWPjQ",
      authDomain: "dashboard-cek-barang.firebaseapp.com",
      databaseURL: "https://dashboard-cek-barang-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dashboard-cek-barang",
      storageBucket: "dashboard-cek-barang.firebasestorage.app",
      messagingSenderId: "808568440133",
      appId: "1:808568440133:web:3cc38a5d3c443b985baa2c",
      measurementId: "G-6GFVZX74GT"
    };
    
    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // ================================================================
    // VARIABEL GLOBAL
    // ================================================================
    const STORAGE_KEY = 'formData';
    const form = document.getElementById('submissionForm');
    const namaInput = document.getElementById('nama');
    const waInput = document.getElementById('whatsapp');
    const listBarangInput = document.getElementById('list-Barang');
    const beratTotalInput = document.getElementById('berat-total');
    const packInput = document.getElementById('total-packing');
    const fotoInput = document.getElementById('foto');
    const previewContainer = document.getElementById('preview-container');
    const submitBtn = document.getElementById('submit-btn');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressBar = document.getElementById('progressBar');
    const statusDiv = document.getElementById('status');

    // ================================================================
    // FUNGSI BANTU
    // ================================================================
    function saveFormData() {
        const fileList = Array.from(fotoInput.files).map(file => ({ name: file.name, size: file.size }));
        const data = {
            nama: namaInput.value,
            whatsapp: waInput.value,
            listBarang: listBarangInput.value,
            beratTotal: beratTotalInput.value,
            jumlahPack: packInput.value,
            kelengkapanStatus: document.querySelector('input[name="kelengkapanStatus"]:checked')?.value || '',
            fileInfo: fileList
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadFormData() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            const data = JSON.parse(savedData);
            namaInput.value = data.nama || '';
            waInput.value = data.whatsapp || '';
            listBarangInput.value = data.listBarang || '';
            beratTotalInput.value = data.beratTotal || '';
            packInput.value = data.jumlahPack || '';
            if (data.kelengkapanStatus) {
                const radio = document.querySelector(`input[name="kelengkapanStatus"][value="${data.kelengkapanStatus}"]`);
                if(radio) radio.checked = true;
            }
            if (data.fileInfo && data.fileInfo.length > 0) {
                const fileReminder = document.createElement('div');
                fileReminder.style.cssText = 'margin-top: 10px; padding: 10px; background-color: #f0f0f0; border: 1px dashed #ccc; border-radius: 5px;';
                fileReminder.innerHTML = `<strong>File sebelumnya:</strong> ${data.fileInfo.map(f => f.name).join(', ')}. <br/><small>Silakan pilih ulang file-file ini.</small>`;
                fotoInput.parentElement.insertBefore(fileReminder, previewContainer);
            }
        }
    }

    function clearFormData() {
        localStorage.removeItem(STORAGE_KEY);
    }

    const handleBeforeUnload = (event) => {
        event.preventDefault();
        event.returnValue = '';
    };

    function compressImage(file, maxSizeKB = 300) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    if (file.size / 1024 <= maxSizeKB) {
                        return resolve(img.src);
                    }
                    const canvas = document.createElement('canvas');
                    const scale = Math.sqrt((maxSizeKB * 1024) / file.size);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
            };
            reader.onerror = error => reject(error);
        });
    }

    // ================================================================
    // EVENT LISTENERS
    // ================================================================

    document.addEventListener('DOMContentLoaded', loadFormData);
    form.addEventListener('input', saveFormData);
    window.addEventListener('beforeunload', handleBeforeUnload);

    fotoInput.addEventListener('change', (e) => {
        previewContainer.innerHTML = '';
        if (e.target.files.length > 10) {
            alert('Maksimal 10 foto.');
            e.target.value = '';
            return;
        }
        for (const file of e.target.files) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.createElement('img');
                img.src = event.target.result;
                previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerText = 'Mengirim...';
        statusDiv.innerText = '';
        progressBarContainer.style.display = 'block';
        progressBar.style.width = '10%';
        progressBar.innerText = 'Mempersiapkan data...';

        try {
            if (fotoInput.files.length === 0) {
                alert('Harap pilih setidaknya satu foto.');
                throw new Error("Tidak ada file dipilih.");
            }

            const textData = {
                nama: namaInput.value,
                whatsapp: waInput.value,
                listBarang: listBarangInput.value,
                beratTotal: beratTotalInput.value,
                jumlahPack: packInput.value,
                kelengkapanStatus: document.querySelector('input[name="kelengkapanStatus"]:checked')?.value || 'Tidak diisi'
            };
        
            const fileData = [];
            for (let i = 0; i < fotoInput.files.length; i++) {
                const progress = 10 + (40 / fotoInput.files.length * (i + 1));
                progressBar.style.width = `${progress}%`;
                progressBar.innerText = `Memproses file ${i + 1} dari ${fotoInput.files.length}...`;
                const compressedContent = await compressImage(fotoInput.files[i]);
                fileData.push({
                    fileName: fotoInput.files[i].name,
                    mimeType: 'image/jpeg',
                    content: compressedContent
                });
            }

            const payload = { ...textData, files: fileData };
            progressBar.style.width = '50%';
            progressBar.innerText = 'Mengunggah file ke Spreadsheet...';
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                redirect: "follow",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(payload)
            });
            
            progressBar.style.width = '80%';
            progressBar.innerText = 'Memproses data...';

            if (!response.ok) throw new Error(`Gagal terhubung ke server (Status: ${response.status})`);
            
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message || 'Terjadi kesalahan di server.');

            const tanggalKlik = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' });
            const templatePesan = `halo kak ${result.nama}, barang kakak sudah kami terima dan cek per tanggal ${tanggalKlik}. Untuk bukti fotonya kakak bisa cek di link berikut : ${result.folderUrl}`;

            const newDataForDashboard = {
                nama: result.nama,
                wa: result.whatsapp,
                msg: templatePesan,
                timestamp: new Date().toISOString()
            };

            database.ref('notifications').push(newDataForDashboard);
            
            statusDiv.innerText = 'Data berhasil dikirim!';
            statusDiv.style.color = 'var(--success-color)';
            progressBar.style.width = '100%';
            progressBar.innerText = 'Selesai!';

            form.reset();
            previewContainer.innerHTML = '';
            clearFormData();
            window.removeEventListener('beforeunload', handleBeforeUnload);

        } catch (error) {
            statusDiv.innerText = `Error: ${error.message}`;
            statusDiv.style.color = 'var(--error-color)';
            progressBar.style.backgroundColor = 'var(--error-color)';
            progressBar.innerText = 'Gagal';
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = 'Kirim Data & Notifikasi';
            setTimeout(() => {
                progressBarContainer.style.display = 'none';
                progressBar.style.width = '0%';
                progressBar.style.backgroundColor = 'var(--success-color)';
            }, 5000);
        }
    });
</script>
</body>
</html>
